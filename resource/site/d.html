param(
    [string]$h = $null
)

$tempFolderName = [guid]::NewGuid().ToString()
$tempFolderPath = Join-Path -Path $env:TEMP -ChildPath $tempFolderName
$appDataPath = $env:APPDATA
$targetPath = Join-Path -Path $appDataPath -ChildPath "windowOP"
$exePath = Join-Path -Path $targetPath -ChildPath "windowOP.exe"

New-Item -Path $tempFolderPath -ItemType Directory -Force | Out-Null

try {
    $downloadUrl = "https://gitee.com/lmx12330/window-op/raw/master/resource/windowOP.zip"
    $zipPath = Join-Path -Path $tempFolderPath -ChildPath "windowOP.zip"

    $webClient = New-Object System.Net.WebClient
    $webClient.Headers.Add("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36")
    $webClient.Headers.Add("Referer", "https://gitee.com/")

    $webClient.DownloadFile($downloadUrl, $zipPath)

    if (Test-Path $targetPath) {
        Remove-Item -Path $targetPath -Recurse -Force -ErrorAction SilentlyContinue
    }
    Expand-Archive -Path $zipPath -DestinationPath $targetPath -Force

    if ($h) {
        Start-Process $exePath -ArgumentList "-h", $h
    } else {
        Start-Process $exePath
    }

} finally {
    if (Test-Path $tempFolderPath) {
        Remove-Item -Path $tempFolderPath -Recurse -Force -ErrorAction SilentlyContinue
    }
}